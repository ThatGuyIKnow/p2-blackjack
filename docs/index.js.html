<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// ======== SETUP ========

const express = require('express');
const fs = require('fs');
const app = express();
const port = process.env.PORT || 1337;
const server = app.listen(port);

const io = require('socket.io')(server);

const solitaire = require("./games/solitaire/solitaire.js");

app.use(express.static('public'));

const options = {

  pingTimeout: 60000, //1 minute(s)
};

const rooms = {

  'room1': {
    connections: [],
    maxConnections: 1,
    state: JSON.parse(fs.readFileSync('testState.json', 'utf-8'))
  },
  'room2': {
    connections: [],
    maxConnections: 6,
    state: {}
  },
  'room3': {
    connections: [],
    maxConnections: 1,
    state: {}
  },
  'room4': {
    connections: [],
    maxConnections: 1,
    state: {}
  },
};

// ======== MIDDLEWARE ========

/**
 * @param {String} data The cookie string
 */
function parseCookie(data) {

  console.log(data);
  let parseData = [...data.matchAll(/([^=\s]*)=([^;\s]*)/gm)];

  /*
   * Converts the parsed data to an object with the key-value pairs found in
   * the cookie (match[0] is the entire cookie string).
   */
  let cookie = {};

  for (let match of parseData) {

    cookie[match[1]] = match[2];
  }

  return cookie;
}

/**
 * Takes the default cookie sent by Socket IO and checks if the socket ID sent
 * in the cookie is already in a room in rooms. If yes, then the socket's new
 * ID (which is created on the new connection) replaces the ID in the room.
 * @param {Object}      socket    The socket to call the middleware on
 * @param {Function}    next      A callback function
 */
const stickySessionMiddleware = (socket, next) => {

  const cookie = socket.request.headers.cookie;

  if (cookie == undefined) {
    next();
    return;
  }

  const id = parseCookie(cookie)['io'];
  if (id == undefined) {
    next();
    return;
  }

  for (let roomKey of Object.keys(rooms)) {

    const connections = rooms[roomKey].connections;

    if (connections.includes(id)) {

      for (let i = 0; i &lt; connections.length; i++) {

        if (connections[i] == id) {
          connections[i] = socket.id;
          socket.join(roomKey);
        }
      }

      addSocketEventHandlers(socket);
      break;
    }
  }
  next();
};
io.use(stickySessionMiddleware);

// ======== CONNECTION HANDLER ========

// The on-connection Socket IO handler
io.on('connection', (socket) => {

  socket.send(`Connected through WebSocket. ID: ${socket.id}`);
  socket.send(`Rooms: ${JSON.stringify(rooms)}`);

  socket.on('accessRoom', (roomID) => {

    if (!Object.keys(rooms).includes(roomID) ||
      rooms[roomID].connections.length >= rooms[roomID].maxConnections) {
      socket.send("Error joining room " + roomID);
    } else {
      leaveRooms(socket);
      socket.join(roomID);
      rooms[roomID].connections.push(socket.id);
      addSocketEventHandlers(socket);
      socket.send(`Rooms: ${JSON.stringify(rooms)}`);
    }
  });

  socket.on('disconnect', (socket) => {
    console.log("disconnected");
  });
});

// ======== EVENT HANDLERS ========

/**
 * Adds the necessary eventhandlers to a socket ( as of now, this only includes
 * eventhandlers for maintaining an connection).
 * @param {Object} socket The socket to apply the handlers
 */
function addSocketEventHandlers(socket) {
  // Disconnects the client if a ping hasn't been send in pingTimeout ms
  let sessionDrop = setTimeout(dropSession, options.pingTimeout, socket);

  socket.on('session ping', () => {
    clearTimeout(sessionDrop);
    sessionDrop = setTimeout(dropSession, options.pingTimeout, socket);
  });

  socket.emit('room control');

  addGameEventHandler(socket);
}

/**
 * Adds a game handler for receiving player actions on the state
 * @param {Object} socket The socket to apply the handlers
 */
function addGameEventHandler(socket) {

  socket.on('player action', (action, callback) => {

    let room = Object.values(rooms).find((room) =>
      room.connections.includes(socket.id)
    );

    if (room == undefined) return;

    if (Object.keys(room.state).length == 0) {
      solitaire.init((state) => {
        room.state = state;
      });
    } else {
      solitaire.action(room.state, action, (state, err) => {
        if (err) {
          socket.send(err);
        } else {
          room.state = state;
        }
      });
    }
    if (Object.keys(room.state) != 0) {
      const playerState = solitaire.filterState(room.state);
      socket.to('room2').emit('room update', playerState);
      callback(playerState);
    } else {
      socket.send("Game has concluded!");
      callback(room.state);
      dropSession(socket);
    }

  });
}

// ======== HELPER FUNCTION(S) ========

/**
 * Removes a socket from all rooms and disconnects the socket.
 * @param {Object} socket The socket to drop
 */
function dropSession(socket) {

  leaveRooms(socket);

  if (socket.connected) {
    socket.send(`Disconnected from Socket IO Session`);
    socket.send(`Rooms: ${JSON.stringify(rooms)}`);
    socket.disconnect();
  }
}

/**
 * Removes a socket from all rooms (expect its ID room)
 * @param {Object} socket The socket to leave rooms
 */
function leaveRooms(socket) {

  for (let roomKey of Object.keys(rooms)) {

    const room = rooms[roomKey];

    if (room.connections.includes(socket.id)) {
      socket.leave(roomKey);
      room.connections = room.connections.filter((e) => e != socket.id);
    }
  }
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#accessRoom">accessRoom</a></li><li><a href="global.html#addGameEventHandler">addGameEventHandler</a></li><li><a href="global.html#addHandlers">addHandlers</a></li><li><a href="global.html#addSocketEventHandlers">addSocketEventHandlers</a></li><li><a href="global.html#buildDeck">buildDeck</a></li><li><a href="global.html#canMoveTableau">canMoveTableau</a></li><li><a href="global.html#createCard">createCard</a></li><li><a href="global.html#createTableaus">createTableaus</a></li><li><a href="global.html#deepCopy">deepCopy</a></li><li><a href="global.html#dropSession">dropSession</a></li><li><a href="global.html#init">init</a></li><li><a href="global.html#isCorrectPlacementFoundation">isCorrectPlacementFoundation</a></li><li><a href="global.html#isCorrectPlacementTableau">isCorrectPlacementTableau</a></li><li><a href="global.html#leaveRooms">leaveRooms</a></li><li><a href="global.html#movePile">movePile</a></li><li><a href="global.html#parseCookie">parseCookie</a></li><li><a href="global.html#playerAction">playerAction</a></li><li><a href="global.html#pushCards">pushCards</a></li><li><a href="global.html#randomNumber">randomNumber</a></li><li><a href="global.html#removeCardFoundation">removeCardFoundation</a></li><li><a href="global.html#removeCards">removeCards</a></li><li><a href="global.html#removeCardsTableau">removeCardsTableau</a></li><li><a href="global.html#removeCardStockpile">removeCardStockpile</a></li><li><a href="global.html#render">render</a></li><li><a href="global.html#renderFoundation">renderFoundation</a></li><li><a href="global.html#renderStockpile">renderStockpile</a></li><li><a href="global.html#renderTableau">renderTableau</a></li><li><a href="global.html#ruleset">ruleset</a></li><li><a href="global.html#shuffleDeck">shuffleDeck</a></li><li><a href="global.html#stickySessionMiddleware">stickySessionMiddleware</a></li><li><a href="global.html#tableau">tableau</a></li><li><a href="global.html#verifyEndState">verifyEndState</a></li><li><a href="global.html#verifyFromFoundation">verifyFromFoundation</a></li><li><a href="global.html#verifyFromStockpile">verifyFromStockpile</a></li><li><a href="global.html#verifyFromTableau">verifyFromTableau</a></li><li><a href="global.html#verifyMovePile">verifyMovePile</a></li><li><a href="global.html#verifyToFoundation">verifyToFoundation</a></li><li><a href="global.html#verifyToTableau">verifyToTableau</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.4</a> on Wed May 13 2020 10:27:38 GMT+0200 (Central European Summer Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
